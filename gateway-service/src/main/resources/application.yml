server:
  port: 8080

spring:
  application:
    name: gateway-service

  cloud:
    gateway:
      # Route configurations
      routes:
        # IAM Service Routes
        - id: iam-service
          uri: lb://iam-service
          predicates:
            - Path=/api/iam/**
          filters:
            - StripPrefix=2

        # Business Service Routes
        - id: business-service
          uri: lb://business-service
          predicates:
            - Path=/api/business/**
          filters:
            - StripPrefix=2

        # Process Management Service Routes
        - id: process-service
          uri: lb://process-service
          predicates:
            - Path=/api/process/**
          filters:
            - StripPrefix=2

        # Integration Service Routes
        - id: integration-service
          uri: lb://integration-service
          predicates:
            - Path=/api/integration/**
          filters:
            - StripPrefix=2

      # Global CORS configuration
      globalcors:
        corsConfigurations:
          '[/**]':
            allowedOriginPatterns: "*"
            allowedMethods:
              - GET
              - POST
              - PUT
              - DELETE
              - PATCH
              - OPTIONS
            allowedHeaders: "*"
            allowCredentials: true
            maxAge: 3600

      # Default filters for all routes
      default-filters:
        - name: Retry
          args:
            retries: 3
            statuses: BAD_GATEWAY,GATEWAY_TIMEOUT
            methods: GET,POST
            backoff:
              firstBackoff: 50ms
              maxBackoff: 500ms
              factor: 2
              basedOnPreviousValue: true

  # Security OAuth2 Configuration
  security:
    oauth2:
      # OAuth2 Client (for Login flow)
      client:
        registration:
          keycloak:
            client-id: ${KEYCLOAK_CLIENT_ID:gateway-service}
            client-secret: ${KEYCLOAK_CLIENT_SECRET:}
            authorization-grant-type: authorization_code
            redirect-uri: "{baseUrl}/login/oauth2/code/{registrationId}"
            scope: openid,profile,email
            client-name: Keycloak
        provider:
          keycloak:
            issuer-uri: ${KEYCLOAK_ISSUER_URI:http://localhost:8180/realms/enterprise}
            authorization-uri: ${KEYCLOAK_ISSUER_URI:http://localhost:8180/realms/enterprise}/protocol/openid-connect/auth
            token-uri: ${KEYCLOAK_ISSUER_URI:http://localhost:8180/realms/enterprise}/protocol/openid-connect/token
            user-info-uri: ${KEYCLOAK_ISSUER_URI:http://localhost:8180/realms/enterprise}/protocol/openid-connect/userinfo
            jwk-set-uri: ${KEYCLOAK_JWK_SET_URI:http://localhost:8180/realms/enterprise/protocol/openid-connect/certs}
            user-name-attribute: preferred_username

      # OAuth2 Resource Server (for JWT validation)
      resourceserver:
        jwt:
          issuer-uri: ${KEYCLOAK_ISSUER_URI:http://localhost:8180/realms/enterprise}
          jwk-set-uri: ${KEYCLOAK_JWK_SET_URI:http://localhost:8180/realms/enterprise/protocol/openid-connect/certs}

  # Redis L2 Cache Configuration
  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:}
      database: 0
      lettuce:
        pool:
          max-active: 20
          max-idle: 10
          min-idle: 5
      timeout: 3000ms

# Management and Monitoring
management:
  endpoints:
    web:
      exposure:
        include: health,info,prometheus,metrics,gateway
  endpoint:
    health:
      show-details: always
  metrics:
    export:
      prometheus:
        enabled: true
    distribution:
      percentiles-histogram:
        http.server.requests: true
  tracing:
    sampling:
      probability: 1.0
  zipkin:
    tracing:
      endpoint: ${ZIPKIN_ENDPOINT:http://localhost:9411/api/v2/spans}

# Logging
logging:
  level:
    root: INFO
    com.enterprise: DEBUG
    org.springframework.cloud.gateway: DEBUG
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} [traceId=%X{traceId:-}] - %msg%n"

# Resilience4j Configuration
resilience4j:
  circuitbreaker:
    configs:
      default:
        # Sliding window configuration
        slidingWindowType: COUNT_BASED
        slidingWindowSize: 100
        minimumNumberOfCalls: 10

        # Failure thresholds
        failureRateThreshold: 50
        slowCallRateThreshold: 50
        slowCallDurationThreshold: 2000ms

        # State transitions
        waitDurationInOpenState: 10s
        permittedNumberOfCallsInHalfOpenState: 10
        automaticTransitionFromOpenToHalfOpenEnabled: true

        # Record exceptions as failures
        recordExceptions:
          - java.io.IOException
          - java.net.SocketTimeoutException
          - org.springframework.web.client.HttpServerErrorException

        ignoreExceptions:
          - java.lang.IllegalArgumentException
          - java.lang.IllegalStateException

    instances:
      iam-service:
        baseConfig: default
      business-service:
        baseConfig: default
      process-service:
        baseConfig: default
      integration-service:
        baseConfig: default
        failureRateThreshold: 60  # More lenient for external services

  retry:
    configs:
      default:
        maxAttempts: 3
        waitDuration: 100ms
        enableExponentialBackoff: true
        exponentialBackoffMultiplier: 2
        exponentialMaxWaitDuration: 1000ms

        retryExceptions:
          - java.io.IOException
          - java.net.SocketTimeoutException
          - java.net.ConnectException

        ignoreExceptions:
          - java.lang.IllegalArgumentException

    instances:
      iam-service:
        baseConfig: default
      business-service:
        baseConfig: default
      process-service:
        baseConfig: default
      integration-service:
        baseConfig: default
        maxAttempts: 5  # More retries for external services

  ratelimiter:
    configs:
      default:
        limitForPeriod: 1000
        limitRefreshPeriod: 1s
        timeoutDuration: 100ms

    instances:
      iam-service:
        baseConfig: default
      business-service:
        baseConfig: default
      process-service:
        baseConfig: default
      integration-service:
        baseConfig: default
        limitForPeriod: 500  # Lower limit for external

  bulkhead:
    configs:
      default:
        maxConcurrentCalls: 100
        maxWaitDuration: 100ms

    instances:
      iam-service:
        baseConfig: default
      business-service:
        baseConfig: default
      process-service:
        baseConfig: default
      integration-service:
        baseConfig: default
        maxConcurrentCalls: 50

  timelimiter:
    configs:
      default:
        timeoutDuration: 5s

    instances:
      iam-service:
        timeoutDuration: 3s
      business-service:
        timeoutDuration: 5s
      process-service:
        timeoutDuration: 10s
      integration-service:
        timeoutDuration: 15s  # Longer for external calls

# Rate Limiting Configuration
ratelimit:
  anonymous:
    capacity: 100  # 100 req/min for anonymous
  authenticated:
    capacity: 1000  # 1000 req/min for authenticated
  premium:
    capacity: 10000  # 10000 req/min for premium

# CCU (Concurrent Users) Metrics Configuration
ccu:
  metrics:
    enabled: true  # Enable/disable CCU tracking
    schedule:
      # Fixed delay between collection cycles (ms)
      # Recommended: 30s for 10K-100K users, 60s for 100K-1M users
      fixed-delay: 30000  # 30 seconds
      # Initial delay before first collection (ms)
      initial-delay: 10000  # 10 seconds (allow services to start)
    scan:
      # Redis SCAN batch size (higher = faster but more memory)
      batch-size: 1000  # Count parameter for SCAN command
    online:
      # TTL for online:{userId} keys (in minutes)
      # This determines how long a user is considered "online" after their last request
      # Recommended: 2-3 minutes for accurate real-time CCU
      # Trade-off: Lower = more accurate but users may flicker offline, Higher = less accurate
      ttl-minutes: 2  # 2 minutes
    tracking:
      # Enable per-service CCU breakdown (requires storing service info in online keys)
      # Warning: Adds overhead, disable for better performance
      by-service: false
      # Enable per-endpoint CCU breakdown (future enhancement)
      by-endpoint: false

# Dashboard Metrics Configuration
dashboard:
  metrics:
    # Enable dashboard metrics collection
    enabled: true
    # Traffic history retention (hours)
    traffic-history-hours: 24
    # Slow endpoint threshold (milliseconds)
    slow-endpoint-threshold: 500

# Metrics Reporter Configuration (for downstream services)
metrics:
  reporter:
    # Enable automatic metrics reporting to Redis
    enabled: true
    # Heartbeat interval (milliseconds) - how often to report health metrics
    heartbeat-interval: 5000  # 5 seconds
